<div class="bg-white shadow rounded p-4">
  <div class="flex items-center justify-between mb-3">
    <h2 class="font-semibold">Itens de execução</h2>
    <div class="text-sm text-gray-500">{{ itens|length }} item(ns)</div>
  </div>

  {% if config_total > 0 %}
    <div class="mb-4">
      <div class="flex items-center justify-between text-sm text-gray-600">
        <span>Configuração técnica</span>
        <span class="font-medium">{{ config_done }}/{{ config_total }} ({{ config_pct }}%)</span>
      </div>
      <div class="mt-2 h-2 w-full rounded bg-gray-100 border overflow-hidden">
        <div class="h-2 rounded bg-green-500 transition-all duration-500" style="width: {{ config_pct }}%;"></div>
      </div>
    </div>
  {% else %}
    <div class="mb-4 text-sm text-gray-600 bg-gray-50 border rounded p-2">
      Configuração não obrigatória neste chamado.
    </div>
  {% endif %}

  <!-- ==========================
       FORM PRINCIPAL: salvar itens
       ========================== -->
  <form id="form-itens" method="post" action="{% url 'execucao:chamado_atualizar_itens' chamado.id %}">
    {% csrf_token %}

    <div class="space-y-4">
      {% for item in itens %}
        <div class="border rounded p-3">
          <div class="flex flex-col gap-1 md:flex-row md:items-center md:justify-between">
            <div class="font-medium">
              {{ item.equipamento.nome }} — {{ item.tipo }}
            </div>

            <div class="text-sm text-gray-600">
              Qtd: <span class="font-medium">{{ item.quantidade }}</span>

              {% if item.tem_ativo %}
                <span class="ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded bg-orange-100 text-orange-800 font-medium">Rastreável</span>
              {% else %}
                <span class="ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded bg-sky-100 text-sky-800 font-medium">Contável</span>
              {% endif %}

              {% if item.equipamento.configuravel %}
                <span class="ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded bg-violet-100 text-violet-800 font-medium">Configurável</span>
              {% else %}
                <span class="ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded bg-slate-100 text-slate-600 font-medium">Não configurável</span>
              {% endif %}
            </div>
          </div>

          {% if item.tem_ativo %}
            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 border-b pb-3 mb-3">
              <div>
                <label class="block text-[11px] uppercase tracking-wider text-gray-500 font-bold mb-1">Ativo</label>
                <input
                  name="ativo_{{ item.id }}"
                  value="{{ item.ativo|default_if_none:'' }}"
                  class="w-full border rounded px-3 py-2 text-sm"
                  {% if chamado.finalizado_em %}disabled{% endif %}
                />
              </div>
              <div>
                <label class="block text-[11px] uppercase tracking-wider text-gray-500 font-bold mb-1">Número de Série</label>
                <input
                  name="serie_{{ item.id }}"
                  value="{{ item.numero_serie|default_if_none:'' }}"
                  class="w-full border rounded px-3 py-2 text-sm"
                  {% if chamado.finalizado_em %}disabled{% endif %}
                />
              </div>
            </div>
          {% else %}
            <div class="mt-3 flex items-center gap-2 border-b pb-3 mb-3">
              <input
                type="checkbox"
                name="confirmado_{{ item.id }}"
                {% if item.confirmado %}checked{% endif %}
                {% if chamado.finalizado_em %}disabled{% endif %}
                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span class="text-sm">Confirmado instalação física</span>
            </div>
          {% endif %}

          <!-- ==========================
               CONFIGURAÇÃO (decisão operacional)
               ========================== -->
          {% if item.equipamento.configuravel %}
            <div class="mt-3 border-t pt-3">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div class="flex items-center gap-2">
                  <input
                    type="checkbox"
                    name="deve_configurar_{{ item.id }}"
                    {% if item.deve_configurar %}checked{% endif %}
                    {% if chamado.finalizado_em %}disabled{% endif %}
                    class="rounded border-gray-300 text-violet-600 focus:ring-violet-500"
                  />
                  <div class="text-sm">
                    <span class="font-medium">Configurar este item</span>
                    <span class="text-gray-500"> (decisão do chamado)</span>
                  </div>
                </div>

                {% if item.deve_configurar %}
                  <div class="text-xs text-gray-500">
                    Para finalizar: exige <span class="font-medium">Status CONFIGURADO</span> + <span class="font-medium">IP</span>.
                  </div>
                {% endif %}
              </div>

              {% if item.deve_configurar %}
                <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-[11px] uppercase tracking-wider text-gray-500 font-bold mb-1">IP</label>
                    <input
                      name="ip_{{ item.id }}"
                      value="{{ item.ip|default_if_none:'' }}"
                      class="w-full border rounded px-3 py-2 text-sm"
                      placeholder="ex: 10.0.0.10"
                      {% if chamado.finalizado_em %}disabled{% endif %}
                    />
                  </div>

                  <div>
                    <label class="block text-[11px] uppercase tracking-wider text-gray-500 font-bold mb-1">Status de Configuração</label>

                    <div class="flex flex-wrap gap-1">
                      <button
                        type="button"
                        class="js-status-btn px-3 py-1.5 rounded border text-xs font-medium transition-colors
                              {% if item.status_configuracao == 'AGUARDANDO' %}bg-gray-200 border-gray-400 text-gray-900 shadow-sm{% else %}bg-white border-gray-200 text-gray-600 hover:bg-gray-50{% endif %}"
                        data-form-id="form-status-{{ item.id }}-AGUARDANDO"
                        data-requires-reason="{% if item.status_configuracao == 'CONFIGURADO' %}1{% else %}0{% endif %}"
                        {% if chamado.finalizado_em %}disabled{% endif %}
                      >
                        Aguardando
                      </button>

                      <button
                        type="submit"
                        form="form-status-{{ item.id }}-EM_CONFIGURACAO"
                        class="px-3 py-1.5 rounded border text-xs font-medium transition-colors
                               {% if item.status_configuracao == 'EM_CONFIGURACAO' %}bg-blue-600 border-blue-700 text-white shadow-sm{% else %}bg-white border-gray-200 text-gray-600 hover:bg-gray-50{% endif %}"
                        {% if chamado.finalizado_em %}disabled{% endif %}
                      >
                        Em execução
                      </button>

                      <button
                        type="submit"
                        form="form-status-{{ item.id }}-CONFIGURADO"
                        class="px-3 py-1.5 rounded border text-xs font-medium transition-colors
                               {% if item.status_configuracao == 'CONFIGURADO' %}bg-green-600 border-green-700 text-white shadow-sm{% else %}bg-white border-gray-200 text-gray-600 hover:bg-gray-50{% endif %}"
                        {% if chamado.finalizado_em %}disabled{% endif %}
                      >
                        Configurado
                      </button>
                    </div>
                  </div>
                </div>
              {% else %}
                <div class="mt-3">
                  <span class="inline-flex items-center px-2 py-1 text-[10px] font-bold uppercase rounded bg-gray-50 text-gray-400 border border-gray-100">
                    Configuração opcional (não marcada)
                  </span>
                </div>
              {% endif %}
            </div>
          {% else %}
            <div class="mt-3">
              <span class="inline-flex items-center px-2 py-1 text-[10px] font-bold uppercase rounded bg-gray-50 text-gray-400 border border-gray-100">
                Não configurável (cadastro)
              </span>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </form>

  <!-- forms de status ficam fora do form-itens -->
  {% for item in itens %}
    {% if item.equipamento.configuravel %}
      <form
        id="form-status-{{ item.id }}-AGUARDANDO"
        method="post"
        action="{% url 'execucao:item_set_status_configuracao' chamado.id item.id %}"
        class="hidden"
      >
        {% csrf_token %}
        <input type="hidden" name="status" value="AGUARDANDO">
        <input type="hidden" name="motivo" value="">
      </form>

      <form
        id="form-status-{{ item.id }}-EM_CONFIGURACAO"
        method="post"
        action="{% url 'execucao:item_set_status_configuracao' chamado.id item.id %}"
        class="hidden"
      >
        {% csrf_token %}
        <input type="hidden" name="status" value="EM_CONFIGURACAO">
      </form>

      <form
        id="form-status-{{ item.id }}-CONFIGURADO"
        method="post"
        action="{% url 'execucao:item_set_status_configuracao' chamado.id item.id %}"
        class="hidden"
      >
        {% csrf_token %}
        <input type="hidden" name="status" value="CONFIGURADO">
      </form>
    {% endif %}
  {% endfor %}

  {% if not itens %}
    <div class="text-sm text-gray-600">Nenhum item gerado para este chamado.</div>
  {% endif %}
</div>